<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Black Hole</title>
<style>
:root{
  --bg-light:#f9fafb; --panel-light:#fff; --text-light:#0a0a0a; --muted-light:#6b6b6b; --accent-light:#007aff;
  --bg-dark:#0f0f10; --panel-dark:#161616; --text-dark:#e6e6e6; --muted-dark:#9a9a9a; --accent-dark:#00bfff;
  --users-width:260px; --font:"Courier New", monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;width:100%}
body{font-family:var(--font);height:100vh;width:100vw;overflow:hidden;display:flex;align-items:stretch;position:relative}
body::before{
  content:"";
  position:absolute;
  top:50%; left:50%;
  width:600px; height:600px;
  background:url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Logo_of_the_National_Security_Agency_and_Central_Security_Service.svg/2560px-Logo_of_the_National_Security_Agency_and_Central_Security_Service.svg.png') no-repeat center/contain;
  opacity:0.05;
  transform:translate(-50%,-50%) rotate(-30deg);
  pointer-events:none;
  z-index:0;
}

body[data-theme="light"]{background:var(--bg-light);color:var(--text-light);}
body[data-theme="light"] .container {background:var(--panel-light);color:var(--text-light);}
body[data-theme="light"] .accent {color:var(--accent-light);}
body[data-theme="light"] .users {background:#f1f1f1;}
body[data-theme="light"] .messages {background:#fbfbfb;color:var(--text-light);}
body[data-theme="light"] .msg.other {background:#e9e9e9;color:var(--text-light);}

body[data-theme="dark"]{background:var(--bg-dark);color:var(--text-dark);}
body[data-theme="dark"] .container {background:var(--panel-dark);color:var(--text-dark);}
body[data-theme="dark"] .accent {color:var(--accent-dark);}
body[data-theme="dark"] .users {background:#141414;}
body[data-theme="dark"] .messages {background:#0b0b0b;color:var(--text-dark);}
body[data-theme="dark"] .msg.other {background:#222;color:var(--text-dark);}

.container{display:flex;flex-direction:column;width:100vw;height:100vh;position:relative;z-index:1;}
header{display:flex;flex-direction:column;align-items:center;padding:10px 14px;border-bottom:1px solid rgba(0,0,0,0.06);position:relative;z-index:2;}
.logo{height:48px;margin-bottom:6px;}
.title{font-weight:bold;font-size:16px;}
.controls{display:flex;gap:8px;align-items:center;}
.nick{cursor:pointer;padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:transparent;font-size:13px;}
.theme-btn{cursor:pointer;padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:transparent;font-size:14px;}

.main{display:flex;flex:1;min-height:0;}
.left{display:flex;flex-direction:column;flex:1;min-width:0;}
.messages{flex:1;overflow:auto;padding:12px;font-size:14px;}
.msg{margin-bottom:8px;padding:6px 8px;border-radius:6px;max-width:78%;word-break:break-word;}
.msg.me{background:transparent;border:1px solid rgba(0,0,0,0.06);align-self:flex-end;color:inherit;}
.msg.other{align-self:flex-start;}
.meta{font-size:12px;color:rgba(0,0,0,0.45);cursor:pointer;margin-bottom:4px;display:block;}
.meta.dark{color:rgba(255,255,255,0.45);}
.composer{display:flex;padding:10px;border-top:1px solid rgba(0,0,0,0.06);gap:8px;}
.composer input[type="text"]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);font-size:14px;}
.composer button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:#007aff;color:white;font-weight:600;}

.right{width:var(--users-width);border-left:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;min-width:200px;max-width:360px;}
.users{padding:10px;overflow:auto;flex:1;}
.users .user{padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer;border:1px solid rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center;}
.about{padding:12px;overflow:auto;display:none;}

#privatePanel{display:none;flex-direction:column;height:100%;border-top:1px solid rgba(0,0,0,0.06);}
#privateMessages{flex:1;overflow:auto;padding:12px;font-size:14px;background:rgba(0,0,0,0.05);}
#privateComposer{display:flex;padding:8px;gap:6px;border-top:1px solid rgba(0,0,0,0.06);}
#privateComposer input{flex:1;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);}

@media(max-width:900px){.right{display:none;}}
</style>
</head>
<body data-theme="dark">
<div class="container">
<header>
  <img src="https://media0.giphy.com/media/v1.Y2lkPTZjMDliOTUyanM4bGFiNnV3eWIzdzcwMzQzYWZjNWJkd3FubXhlcjZnbm55Z2h3ZyZlcD12MV9zdGlja2Vyc19zZWFyY2gmY3Q9cw/9iSlGflR0l9987MiFs/giphy.gif" alt="Logo" class="logo"/>
  <div class="title accent">Black Hole</div>
  <div class="controls">
    <div id="nick" class="nick" title="Clique para editar seu nickname">...</div>
    <button id="themeToggle" class="theme-btn">☀️</button>
  </div>
</header>

<div class="main">
  <div class="left">
    <div id="messages" class="messages" aria-live="polite"></div>
    <div class="composer">
      <input id="texto" type="text" placeholder="Digite sua mensagem"/>
      <button id="send">Enviar</button>
    </div>
    <div id="privatePanel">
      <div id="privateMessages"></div>
      <div id="privateComposer">
        <input id="privateInput" type="text" placeholder="Mensagem da sala privada"/>
        <button id="privateSend">Enviar</button>
      </div>
    </div>
  </div>

  <div class="right">
    <div style="padding:10px;border-bottom:1px solid rgba(0,0,0,0.04);font-weight:bold">Usuários na sala</div>
    <div id="usersList" class="users">Carregando...</div>
  </div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDnU0__Y6KTjYZq7h2OqzDvczw9Z4lCYyM",
  authDomain:"lol-irc1.firebaseapp.com",
  databaseURL:"https://lol-irc1-default-rtdb.firebaseio.com",
  projectId:"lol-irc1",
  storageBucket:"lol-irc1.firebasestorage.app",
  messagingSenderId:"947292658625",
  appId:"1:947292658625:web:9255c2124aa24a7d7f6d40"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// E2EE para sala privada (local)
let ecdhKeyPair=null,myPublicBase64=null,sharedKeyCache={};
async function genKeyPair(){
  ecdhKeyPair=await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},true,["deriveKey","deriveBits"]);
  const pubRaw=await crypto.subtle.exportKey("raw",ecdhKeyPair.publicKey);
  myPublicBase64=btoa(String.fromCharCode(...new Uint8Array(pubRaw)));
}
async function importOther(rawBase64){
  const raw=Uint8Array.from(atob(rawBase64),c=>c.charCodeAt(0)).buffer;
  return await crypto.subtle.importKey("raw",raw,{name:"ECDH",namedCurve:"P-256"},true,[]);
}
async function deriveKey(otherBase64,target){ 
  if(sharedKeyCache[target]) return sharedKeyCache[target];
  const otherPub=await importOther(otherBase64);
  const derivedBits=await crypto.subtle.deriveBits({name:"ECDH",public:otherPub},ecdhKeyPair.privateKey,256);
  const key=await crypto.subtle.importKey("raw",derivedBits,{name:"AES-GCM"},false,["encrypt","decrypt"]);
  sharedKeyCache[target]=key;
  return key;
}
async function encryptText(target,text){
  const key=await deriveKey(myPublicBase64,target);
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(text));
  return {ct:btoa(String.fromCharCode(...new Uint8Array(ct))),iv:btoa(String.fromCharCode(...iv))};
}
async function decryptText(target,ctB64,ivB64){
  try{
    const key=await deriveKey(myPublicBase64,target);
    const ct=Uint8Array.from(atob(ctB64),c=>c.charCodeAt(0));
    const iv=Uint8Array.from(atob(ivB64),c=>c.charCodeAt(0));
    const plain=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
    return new TextDecoder().decode(plain);
  }catch(e){return"[Não possível descriptografar]";}
}

// Nick
let nick=localStorage.getItem('anon_nick')||("user"+Math.floor(Math.random()*9000+1000));
localStorage.setItem('anon_nick',nick);
document.getElementById('nick').innerText=nick;
document.getElementById('nick').addEventListener('click',()=>{
  const n=prompt("Digite seu novo nickname:",nick);
  if(n&&n.trim()){nick=n.trim();localStorage.setItem('anon_nick',nick);document.getElementById('nick').innerText=nick;}
});

// Chat público
const messagesEl=document.getElementById('messages');
const input=document.getElementById('texto');
const sendBtn=document.getElementById('send');
const usersListEl=document.getElementById('usersList');
const messagesRef=db.ref('rooms/default/messages');

messagesRef.limitToLast(200).on('child_added',snap=>{
  const m=snap.val(); if(!m) return;
  const div=document.createElement('div');
  div.className='msg '+(m.nick===nick?'me':'other');
  const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`[${new Date(m.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}] <${m.nick}>`;
  const body=document.createElement('div'); body.textContent=m.text;
  div.appendChild(meta); div.appendChild(body);
  messagesEl.appendChild(div);
  messagesEl.scrollTop=messagesEl.scrollHeight;
});

sendBtn.addEventListener('click',send);
input.addEventListener('keydown',e=>{if(e.key==='Enter')send();});
function send(){
  const t=input.value.trim(); if(!t) return;
  // Sala privada
  if(t.startsWith("/private")){
    const p=t.split(" "); if(p[1]==="nsa_snowden" && p[2]==="5n0wd3n"){
      document.getElementById('privatePanel').style.display='flex';
      alert("Bem-vindo à sala privada NSA Snowden!");
      input.value=""; return;
    } else {alert("Usuário ou senha incorretos!"); input.value=""; return;}
  }
  messagesRef.push({nick,text:t,ts:Date.now()});
  input.value="";
}

// Sala privada local com E2EE
const privatePanel=document.getElementById('privatePanel');
const privateInput=document.getElementById('privateInput');
const privateSend=document.getElementById('privateSend');
const privateMessages=document.getElementById('privateMessages');

privateSend.addEventListener('click',async ()=>{
  const t=privateInput.value.trim(); if(!t) return;
  const enc=await encryptText('NSA_Private',t);
  const div=document.createElement('div'); div.className='msg me';
  const meta=document.createElement('div'); meta.className='meta'; meta.textContent='[Privado '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+']';
  const body=document.createElement('div'); body.textContent=t;
  div.appendChild(meta); div.appendChild(body);
  privateMessages.appendChild(div); privateMessages.scrollTop=privateMessages.scrollHeight;
  privateInput.value="";
});
privateInput.addEventListener('keydown',e=>{if(e.key==='Enter')privateSend.click();});

// Presença
const presenceRef=db.ref('rooms/default/presence');
presenceRef.on('value',snap=>{
  const val=snap.val()||{};
  usersListEl.innerHTML='';
  Object.values(val).sort((a,b)=>a.nick.localeCompare(b.nick)).forEach(u=>{
    const item=document.createElement('div'); item.className='user'; item.textContent=u.nick+(u.nick===nick?' (você)':'');
    usersListEl.appendChild(item);
  });
});

// Tema
const themeToggle=document.getElementById('themeToggle');
const storedTheme=localStorage.getItem('theme')||'dark';
document.body.setAttribute('data-theme',storedTheme);
themeToggle.textContent=storedTheme==='light'?'🌙':'☀️';
themeToggle.addEventListener('click',()=>{
  const cur=document.body.getAttribute('data-theme'); const next=cur==='light'?'dark':'light';
  document.body.setAttribute('data-theme',next); localStorage.setItem('theme',next);
  themeToggle.textContent=next==='light'?'🌙':'☀️';
});

genKeyPair();
</script>
</body>
</html>
